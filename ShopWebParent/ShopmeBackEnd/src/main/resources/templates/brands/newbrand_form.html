<!DOCTYPE html>
<html xmlns:th="http://wwww.thymeleaf.org"
	xmls:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head th:replace="fragment :: page_head('New brand form')"></head>
<body>

	<div th:replace="navigation :: Menu"></div>

	&nbsp;

	<div class="text-center">
		<form class="" th:action="@{/brands/new_brand}" method="post"
			enctype="multipart/form-data" onsubmit="return checkunique(this)" th:object=${brands}
			style="width: 550px; margin: auto;">
			<input type="hidden" th:field="*{brandId}" />
			<div class="border border-secondary rounded p-3">

				<div class="form-group row">
					<label class="col-sm-4 col-form-label">Brand Name</label>
					<div class="col-sm-8">
						<input type="text" class="form-control" th:field="*{brandName}"
							required min="3" maxlength="128" />
					</div>
				</div>

				<div class="form-group row">
					<label class="col-sm-4 col-form-label">Brand Logo</label>
					<div class="col-sm-8">
						<input type="file" class="form-control mb-2" required min="3"
							maxlength="128" id="fileImage" name="fileImage"
							accept="image/png, image/jpeg" />
					</div>
					<div class="mt-2">
						<img id="thumbnail" alt="Image-Preview" class="img-fluid" />
					</div>
				</div>

				<div class="form-group row">
					<label class="col-sm-4 col-form-label">Category</label>
					<div class="col-sm-8">
						<select class="form-control" th:field="*{brandCategory}" multiple
							required style="resize: vertical; height: 200px">
							<th:block th:each="cat: ${listcategory}">
								<option th:value="${cat.categoryId}">[[${cat.categoryName}]]</option>
							</th:block>


						</select>
					</div>
				</div>

				<div class="form-group row">
					<label class="col-sm-4 col-form-lable">Chosen Categories</label>
					<div class="col-sm-8" id="chosencategories"></div>
				</div>

				<div class="text-center">
					<input type="submit" value="Save" class="btn btn-primary m-3" /> <input
						type="button" value="Cancel" class="btn btn-secondary"
						id="buttonCancel" />
				</div>
			</div>
		</form>
	</div>
	<script type="text/javascript">
		moduleUrl = "[[@{/brands}]]"
		
		$(document).ready(function(){
			dropdowncat = $("#brandCategory")
			divchosencategories = $("#chosencategories");
			dropdowncat.change(function(){
			divchosencategories.empty();
				showchosenCategories();
			});
			checkuniquebrand(form);
		});
		
		function showchosenCategories(){
			dropdowncat.children("option:selected").each(function(){
				selectedcat = $(this);
				catId = selectedcat.val();
				catName = selectedcat.text().replace(/-/g, "");
				
				divchosencategories.append("<span class='badge badge-secondary m-1'>"+ catName +"</span>");
			});
		}
		
		
		function checkuniquebrand(form){
			console.log("Inside UNIQUE BRAND CHECK");
			brandname = $("#brandName").val();
			csrfValue = $("input[name='_csrf']").val();
			
			url = "[[@{/brands/checkBrands}]]";
			params = {name:brandname, _csrf=csrfValue};
			
			$.post(url, params, function(response){  
				if(response == "OK"){
					form.submit();
				}else if(response == "Duplicated"){
					alert("Name already exist")
				}
			}).fail(function(){
				alert("Failed request")
			});
			return false;
		};
		
	</script>
</body>
</html>